<script>
    /**
     * ãƒšãƒ¼ã‚¸ã®èª­ã¿è¾¼ã¿å®Œäº†æ™‚ã«å®Ÿè¡Œã•ã‚Œã‚‹åˆæœŸåŒ–é–¢æ•°
     */
    window.addEventListener('load', function() {
        // é€æ¬¡å®Ÿè¡Œï¼šã¾ãšèµ·ç‚¹ãƒ•ã‚©ãƒ«ãƒ€æƒ…å ±ã‚’å–å¾—ã—ã€æˆåŠŸå¾Œã«ãƒ«ãƒ¼ãƒˆãƒ•ã‚©ãƒ«ãƒ€ä¸€è¦§ã‚’å–å¾—ã™ã‚‹
        google.script.run
            .withSuccessHandler(function(folderInfo) {
                // 1. ã¾ãšè¡¨ç¤ºã‚’æ›´æ–°ã™ã‚‹ (setup.js.htmlå†…ã®é–¢æ•°ã‚’å‘¼ã³å‡ºã—)
                updateCurrentFolderDisplay(folderInfo);
                // 2. ç¶šã‘ã¦ãƒ«ãƒ¼ãƒˆãƒ•ã‚©ãƒ«ãƒ€ä¸€è¦§ã®å–å¾—ã‚’é–‹å§‹ã™ã‚‹
                google.script.run
                    .withSuccessHandler(populateFolderDropdown) // (setup.js.htmlå†…ã®é–¢æ•°ã‚’å‘¼ã³å‡ºã—)
                    .withFailureHandler(showError) // (setup.js.htmlå†…ã®é–¢æ•°ã‚’å‘¼ã³å‡ºã—)
                    .listRootFolders();
            })
            .withFailureHandler(showError) // (setup.js.htmlå†…ã®é–¢æ•°ã‚’å‘¼ã³å‡ºã—)
            .getSavedFolderInfo();

        // å„ãƒœã‚¿ãƒ³ã«ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®š
        document.getElementById('save-button').addEventListener('click', saveSettings); // (setup.js.htmlå†…ã®é–¢æ•°ã‚’å‘¼ã³å‡ºã—)
        document.getElementById('load-button').addEventListener('click', loadInitialContents);
        document.getElementById('create-subfolder-button').addEventListener('click', handleCreateSubfolderClick);
        document.getElementById('move-files-button').addEventListener('click', handleMoveFilesClick);
        document.getElementById('refresh-file-list-button').addEventListener('click', handleRefreshFileListClick);
        document.getElementById('bulk-generate-titles-button').addEventListener('click', handleBulkGenerateClick);
        // ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§å†…ã®å‹•çš„ãƒœã‚¿ãƒ³ã¯ã‚¤ãƒ™ãƒ³ãƒˆå§”ä»»ã§å‡¦ç†
        document.getElementById('file-list').addEventListener('click', handleFileListClick);
    });

    /**
     * ã€Œèµ·ç‚¹ãƒ•ã‚©ãƒ«ãƒ€ã®å†…å®¹ã‚’èª­ã¿è¾¼ã‚€ã€ãƒœã‚¿ãƒ³ã®å‡¦ç†
     */
    function loadInitialContents() {
        const loadStatus = document.getElementById('load-status');
        loadStatus.textContent = 'èª­ã¿è¾¼ã¿ä¸­...';
        loadStatus.className = '';
        document.getElementById('subfolder-list').innerHTML = '';
        document.getElementById('file-list').innerHTML = '';

        google.script.run
          .withSuccessHandler(displayInitialView)
          .withFailureHandler(showLoadError)
          .getFolderContents();
    }

    /**
     * ãƒ•ã‚©ãƒ«ãƒ€å†…å®¹ã®åˆæœŸè¡¨ç¤ºï¼ˆã‚µãƒ–ãƒ•ã‚©ãƒ«ãƒ€ã¨å…¨ãƒ•ã‚¡ã‚¤ãƒ«ï¼‰ã‚’æç”»ã™ã‚‹
     * @param {Object} data
     */
    function displayInitialView(data) {
        document.getElementById('load-status').textContent = 'èª­ã¿è¾¼ã¿å®Œäº†ã€‚å·¦ã®ãƒªã‚¹ãƒˆã§çµã‚Šè¾¼ã‚ã¾ã™ã€‚';
        document.getElementById('load-status').className = 'success';
        
        redrawSubfolderList(data.subfolders);
        document.getElementById('subfolder-list').addEventListener('change', handleFilterChange);
        updateFileList(data.files);

        // ãƒ•ã‚©ãƒ«ãƒ€å†…å®¹ãŒèª­ã¿è¾¼ã‚ãŸã®ã§ã€å„æ“ä½œãƒœã‚¿ãƒ³ã‚’æœ‰åŠ¹åŒ–ã™ã‚‹
        document.getElementById('refresh-file-list-button').disabled = false;
        document.getElementById('move-files-button').disabled = false;
        document.getElementById('bulk-generate-titles-button').disabled = false;
    }

    /**
     * çµã‚Šè¾¼ã¿æ¡ä»¶ï¼ˆãƒ©ã‚¸ã‚ªãƒœã‚¿ãƒ³ï¼‰ãŒå¤‰æ›´ã•ã‚ŒãŸæ™‚ã®å‡¦ç†
     * @param {Event} event
     */
    function handleFilterChange(event) {
        const queryText = event.target.value;
        const fileListStatus = document.getElementById('file-list-status');
        fileListStatus.textContent = `ã€Œ${event.target.parentElement.textContent.trim()}ã€ã§æ¤œç´¢ä¸­...`;
        
        google.script.run
            .withSuccessHandler(updateFileList)
            .withFailureHandler(showFileSearchError)
            .searchFiles(queryText);
    }

    /**
     * å¯¾è±¡ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§ã®è¡¨ç¤ºã‚’æ›´æ–°ã™ã‚‹
     * @param {Array<Object>} files
     */
    function updateFileList(files) {
        document.getElementById('file-list-status').textContent = '';
        const fileList = document.getElementById('file-list');
        fileList.innerHTML = '';

        if (!files || files.length === 0) {
            fileList.innerHTML = '<li>å¯¾è±¡ãƒ•ã‚¡ã‚¤ãƒ«ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</li>';
            return;
        }
        
        files.forEach(file => {
            const li = document.createElement('li');
            li.style.flexWrap = 'wrap';
            li.style.flexDirection = 'column';
            li.style.alignItems = 'stretch';
            
            const mainRow = document.createElement('div');
            mainRow.style.display = 'flex';
            mainRow.style.justifyContent = 'space-between';
            mainRow.style.width = '100%';

            const label = document.createElement('label');
            label.style.display = 'flex';
            label.style.alignItems = 'center';
            label.style.flexGrow = '1';
            
            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.className = 'file-checkbox';
            checkbox.value = file.id;
            checkbox.style.marginRight = '10px';
            
            label.appendChild(checkbox);
            label.appendChild(document.createTextNode(file.name));

            const controlsDiv = document.createElement('div');
            controlsDiv.style.display = 'flex';
            controlsDiv.style.alignItems = 'center';

            const typeSpan = document.createElement('span');
            typeSpan.className = 'file-type';
            
            switch (file.type) {
                case 'Google Doc':
                    typeSpan.textContent = 'ğŸ“„';
                    typeSpan.title = 'Google Doc';
                    break;
                case 'PDF':
                    typeSpan.textContent = 'ğŸ“‘';
                    typeSpan.title = 'PDF';
                    break;
                default:
                    typeSpan.textContent = 'â”';
                    typeSpan.title = file.type;
            }
            
            const generateButton = document.createElement('button');
            generateButton.className = 'generate-title-button';
            generateButton.dataset.fileId = file.id;
            generateButton.textContent = 'ã‚¿ã‚¤ãƒˆãƒ«ç”Ÿæˆ';
            generateButton.style.marginLeft = '10px';
            
            controlsDiv.appendChild(typeSpan);
            controlsDiv.appendChild(generateButton);
            
            mainRow.appendChild(label);
            mainRow.appendChild(controlsDiv);
            
            li.appendChild(mainRow);
            
            const suggestionsContainer = document.createElement('div');
            suggestionsContainer.className = 'title-suggestions-container';
            suggestionsContainer.dataset.containerFor = file.id;
            suggestionsContainer.style.display = 'none';
            suggestionsContainer.style.marginTop = '10px';
            suggestionsContainer.style.padding = '10px';
            suggestionsContainer.style.border = '1px solid #ccc';
            suggestionsContainer.style.backgroundColor = '#f9f9f9';
            suggestionsContainer.style.borderRadius = '3px';
            suggestionsContainer.style.width = '100%';

            li.appendChild(suggestionsContainer);

            fileList.appendChild(li);
        });
    }

    /**
     * ãƒ•ã‚©ãƒ«ãƒ€å†…å®¹èª­ã¿è¾¼ã¿æ™‚ã®ã‚¨ãƒ©ãƒ¼ã‚’è¡¨ç¤ºã™ã‚‹
     * @param {Error} error
     */
    function showLoadError(error) {
        const loadStatus = document.getElementById('load-status');
        loadStatus.textContent = 'ã‚¨ãƒ©ãƒ¼: ' + error.message;
        loadStatus.className = 'error';
    }

    /**
     * ãƒ•ã‚¡ã‚¤ãƒ«æ¤œç´¢æ™‚ã®ã‚¨ãƒ©ãƒ¼ã‚’è¡¨ç¤ºã™ã‚‹
     * @param {Error} error
     */
    function showFileSearchError(error) {
         const fileListStatus = document.getElementById('file-list-status');
         fileListStatus.textContent = 'ã‚¨ãƒ©ãƒ¼: ' + error.message;
         fileListStatus.className = 'error';
    }

    /**
     * ã€Œä½œæˆã€ãƒœã‚¿ãƒ³ãŒã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸæ™‚ã®å‡¦ç†
     */
    function handleCreateSubfolderClick() {
        const input = document.getElementById('new-subfolder-name');
        const newName = input.value.trim();
        const statusDiv = document.getElementById('create-folder-status');

        if (newName === '') {
            statusDiv.textContent = 'ãƒ•ã‚©ãƒ«ãƒ€åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚';
            statusDiv.className = 'error';
            return;
        }

        statusDiv.textContent = 'ä½œæˆä¸­...';
        statusDiv.className = '';

        google.script.run
            .withSuccessHandler(function(updatedSubfolders) {
                statusDiv.textContent = `ãƒ•ã‚©ãƒ«ãƒ€ã€Œ${newName}ã€ã‚’ä½œæˆã—ã¾ã—ãŸã€‚`;
                statusDiv.className = 'success';
                input.value = '';
                redrawSubfolderList(updatedSubfolders);
            })
            .withFailureHandler(function(error) {
                statusDiv.textContent = 'ã‚¨ãƒ©ãƒ¼: ' + error.message;
                statusDiv.className = 'error';
            })
            .createSubfolder(newName);
    }

    /**
     * ã‚µãƒ–ãƒ•ã‚©ãƒ«ãƒ€ä¸€è¦§ã®UIï¼ˆãƒ©ã‚¸ã‚ªãƒœã‚¿ãƒ³ï¼‰ã‚’å†æç”»ã™ã‚‹
     * @param {Array<Object>} subfolders - ã‚µãƒ–ãƒ•ã‚©ãƒ«ãƒ€æƒ…å ±ã®é…åˆ—
     */
    function redrawSubfolderList(subfolders) {
        const subfolderList = document.getElementById('subfolder-list');
        subfolderList.innerHTML = '';

        const allLi = document.createElement('li');
        allLi.innerHTML = `<label><input type="radio" name="folder-filter" value="__ALL__" checked> ã™ã¹ã¦è¡¨ç¤º</label>`;
        subfolderList.appendChild(allLi);

        if (subfolders && subfolders.length > 0) {
            subfolders.forEach(folder => {
                const li = document.createElement('li');
                li.innerHTML = `<label><input type="radio" name="folder-filter" value="${folder.name}"> ${folder.name}</label>`;
                subfolderList.appendChild(li);
            });
        }
    }

    /**
     * ã€Œãƒã‚§ãƒƒã‚¯ã—ãŸãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç§»å‹•ã€ãƒœã‚¿ãƒ³ãŒã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸæ™‚ã®å‡¦ç†
     */
    function handleMoveFilesClick() {
        const checkedFiles = document.querySelectorAll('#file-list .file-checkbox:checked');
        const fileIds = Array.from(checkedFiles).map(cb => cb.value);

        const destinationRadio = document.querySelector('input[name="folder-filter"]:checked');
        const destinationFolderName = destinationRadio ? destinationRadio.value : null;

        if (fileIds.length === 0) {
            alert('ç§»å‹•ã™ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«ã‚’1ã¤ä»¥ä¸Šé¸æŠã—ã¦ãã ã•ã„ã€‚');
            return;
        }
        if (!destinationFolderName || destinationFolderName === '__ALL__') {
            alert('ç§»å‹•å…ˆã®ã‚µãƒ–ãƒ•ã‚©ãƒ«ãƒ€ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚ï¼ˆã€Œã™ã¹ã¦è¡¨ç¤ºã€ä»¥å¤–ï¼‰');
            return;
        }

        if (!confirm(`${fileIds.length}å€‹ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã€Œ${destinationFolderName}ã€ãƒ•ã‚©ãƒ«ãƒ€ã«ç§»å‹•ã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ`)) {
            return;
        }

        const statusDiv = document.getElementById('file-list-status');
        statusDiv.textContent = `${fileIds.length}å€‹ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç§»å‹•ä¸­...`;
        statusDiv.className = '';

        const currentFilter = destinationFolderName;

        google.script.run
            .withSuccessHandler(function(updatedFileList) {
                statusDiv.textContent = `${fileIds.length}å€‹ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç§»å‹•ã—ã¾ã—ãŸã€‚`;
                statusDiv.className = 'success';
                updateFileList(updatedFileList);
            })
            .withFailureHandler(showFileSearchError)
            .moveFilesToSubfolder(fileIds, destinationFolderName, currentFilter);
    }

    /**
     * ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§ã‚¨ãƒªã‚¢ã§ã®ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆã‚’å‡¦ç†ã™ã‚‹ï¼ˆã‚¤ãƒ™ãƒ³ãƒˆå§”ä»»ï¼‰
     * @param {Event} event
     */
    function handleFileListClick(event) {
        const target = event.target;
        const fileId = target.dataset.fileId;
        
        if (target.classList.contains('generate-title-button')) {
            handleGenerateTitleClick(fileId, target);
        } else if (target.classList.contains('confirm-title-button')) {
            handleConfirmTitleClick(fileId, target.parentElement);
        } else if (target.classList.contains('cancel-title-button')) {
            const container = target.parentElement;
            container.style.display = 'none';
            const li = container.closest('li');
            if (li) {
                const generateButton = li.querySelector('.generate-title-button');
                if (generateButton) {
                    generateButton.disabled = false;
                }
            }
        }
    }

    /**
     * ã€Œã‚¿ã‚¤ãƒˆãƒ«ç”Ÿæˆã€ãƒœã‚¿ãƒ³ãŒæŠ¼ã•ã‚ŒãŸæ™‚ã®å‡¦ç†
     * @param {string} fileId
     * @param {HTMLElement} buttonElement
     */
    function handleGenerateTitleClick(fileId, buttonElement) {
        const titleCount = document.getElementById('title-count-select').value;
        
        buttonElement.textContent = 'ç”Ÿæˆä¸­...';
        buttonElement.disabled = true;
        buttonElement.classList.add('btn-loading');

        google.script.run
            .withSuccessHandler(function(titleSuggestions) {
                buttonElement.textContent = 'ã‚¿ã‚¤ãƒˆãƒ«ç”Ÿæˆ';
                buttonElement.classList.remove('btn-loading');
                
                const container = document.querySelector(`.title-suggestions-container[data-container-for="${fileId}"]`);
                container.innerHTML = '';
                
                const suggestions = titleSuggestions.replace(/[-*]/g, '').trim().split('\n');
                
                suggestions.forEach((title, index) => {
                    const div = document.createElement('div');
                    const radio = document.createElement('input');
                    radio.type = 'radio';
                    radio.name = `title-suggestion-${fileId}`;
                    radio.id = `title-${fileId}-${index}`;
                    radio.value = title.trim();
                    if(index === 0) radio.checked = true;
                    
                    const label = document.createElement('label');
                    label.htmlFor = `title-${fileId}-${index}`;
                    label.textContent = ` ${title.trim()}`;
                    
                    div.appendChild(radio);
                    div.appendChild(label);
                    container.appendChild(div);
                });
                
                const otherDiv = document.createElement('div');
                const otherRadio = document.createElement('input');
                otherRadio.type = 'radio';
                otherRadio.name = `title-suggestion-${fileId}`;
                otherRadio.id = `title-${fileId}-other`;
                otherRadio.value = 'other';
                
                const otherLabel = document.createElement('label');
                otherLabel.htmlFor = `title-${fileId}-other`;
                otherLabel.textContent = ' ãã®ä»–: ';
                
                const otherInput = document.createElement('input');
                otherInput.type = 'text';
                otherInput.className = 'other-title-input';
                otherInput.style.marginLeft = '5px';
                otherRadio.addEventListener('change', () => otherInput.focus());

                otherDiv.appendChild(otherRadio);
                otherDiv.appendChild(otherLabel);
                otherDiv.appendChild(otherInput);
                container.appendChild(otherDiv);

                const confirmButton = document.createElement('button');
                confirmButton.className = 'confirm-title-button';
                confirmButton.dataset.fileId = fileId;
                confirmButton.textContent = 'æ±ºå®š';
                confirmButton.style.margin = '5px';

                const cancelButton = document.createElement('button');
                cancelButton.className = 'cancel-title-button';
                cancelButton.textContent = 'ã‚­ãƒ£ãƒ³ã‚»ãƒ«';
                cancelButton.style.margin = '5px';

                container.appendChild(confirmButton);
                container.appendChild(cancelButton);
                
                container.style.display = 'block';
            })
            .withFailureHandler(function(error) {
                alert('ã‚¨ãƒ©ãƒ¼: ' + error.message);
                buttonElement.textContent = 'ã‚¿ã‚¤ãƒˆãƒ«ç”Ÿæˆ';
                buttonElement.disabled = false;
                buttonElement.classList.remove('btn-loading');
            })
            .generateTitlesForFile(fileId, titleCount);
    }

    /**
     * ã‚¿ã‚¤ãƒˆãƒ«å€™è£œã®ã€Œæ±ºå®šã€ãƒœã‚¿ãƒ³ãŒæŠ¼ã•ã‚ŒãŸæ™‚ã®å‡¦ç†
     * @param {string} fileId
     * @param {HTMLElement} container
     */
    function handleConfirmTitleClick(fileId, container) {
        let newTitle = '';
        const selectedRadio = container.querySelector(`input[name="title-suggestion-${fileId}"]:checked`);
        
        if (selectedRadio) {
            if (selectedRadio.value === 'other') {
                newTitle = container.querySelector('.other-title-input').value.trim();
            } else {
                newTitle = selectedRadio.value;
            }
        }

        if (newTitle) {
            const li = container.closest('li');
            if (li) {
                const generateButton = li.querySelector('.generate-title-button');
                if (generateButton) {
                    generateButton.disabled = false;
                }
            }
            container.innerHTML = 'åå‰ã‚’å¤‰æ›´ä¸­...';
            google.script.run
                .withSuccessHandler(handleRenameSuccess)
                .withFailureHandler(showFileSearchError)
                .renameFile(fileId, newTitle);
        } else {
            alert('ã‚¿ã‚¤ãƒˆãƒ«ã‚’é¸æŠã¾ãŸã¯å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
        }
    }

    /**
     * ãƒ•ã‚¡ã‚¤ãƒ«åå¤‰æ›´ãŒæˆåŠŸã—ãŸå¾Œã«UIã‚’æ›´æ–°ã™ã‚‹
     */
    function handleRenameSuccess() {
        const statusDiv = document.getElementById('file-list-status');
        statusDiv.textContent = 'ãƒ•ã‚¡ã‚¤ãƒ«åã‚’å¤‰æ›´ã—ã¾ã—ãŸã€‚ã€Œä¸€è¦§ã‚’æ›´æ–°ã€ãƒœã‚¿ãƒ³ã§è¡¨ç¤ºã‚’æ›´æ–°ã—ã¦ãã ã•ã„ã€‚';
        statusDiv.className = 'success';
    }
    
    /**
     * ã€Œä¸€è¦§ã‚’æ›´æ–°ã€ãƒœã‚¿ãƒ³ãŒã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸæ™‚ã®å‡¦ç†
     */
    function handleRefreshFileListClick() {
        const statusDiv = document.getElementById('file-list-status');
        const refreshButton = document.getElementById('refresh-file-list-button');

        statusDiv.textContent = 'ãƒªã‚¹ãƒˆã‚’æ›´æ–°ä¸­...';
        statusDiv.className = '';
        
        refreshButton.disabled = true;
        refreshButton.textContent = 'æ›´æ–°ä¸­...';

        const currentFilter = document.querySelector('input[name="folder-filter"]:checked').value;
        google.script.run
            .withSuccessHandler(function(files) {
                refreshButton.disabled = false;
                refreshButton.textContent = 'ä¸€è¦§ã‚’æ›´æ–°';
                updateFileList(files);
            })
            .withFailureHandler(function(error) {
                refreshButton.disabled = false;
                refreshButton.textContent = 'ä¸€è¦§ã‚’æ›´æ–°';
                showFileSearchError(error);
            })
            .searchFiles(currentFilter);
    }

    /**
     * ã€Œãƒã‚§ãƒƒã‚¯ã—ãŸãƒ•ã‚¡ã‚¤ãƒ«ã®ã‚¿ã‚¤ãƒˆãƒ«ã‚’ç”Ÿæˆã€ãƒœã‚¿ãƒ³ãŒã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸæ™‚ã®å‡¦ç†
     */
    function handleBulkGenerateClick() {
        const checkedFiles = document.querySelectorAll('#file-list .file-checkbox:checked');
        const fileIds = Array.from(checkedFiles).map(cb => cb.value);

        if (fileIds.length === 0) {
            alert('ã‚¿ã‚¤ãƒˆãƒ«ã‚’ç”Ÿæˆã™ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«ã‚’1ã¤ä»¥ä¸Šé¸æŠã—ã¦ãã ã•ã„ã€‚');
            return;
        }

        if (!confirm(`${fileIds.length}å€‹ã®ãƒ•ã‚¡ã‚¤ãƒ«ã®ã‚¿ã‚¤ãƒˆãƒ«ã‚’é †æ¬¡ç”Ÿæˆã—ã€è‡ªå‹•ã§ãƒ•ã‚¡ã‚¤ãƒ«åã‚’å¤‰æ›´ã—ã¾ã™ã€‚ã“ã®å‡¦ç†ã¯æ™‚é–“ãŒã‹ã‹ã‚Šã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ`)) {
            return;
        }
        
        document.getElementById('bulk-generate-titles-button').disabled = true;
        document.getElementById('move-files-button').disabled = true;
        document.getElementById('refresh-file-list-button').disabled = true;

        processFileQueue(fileIds);
    }

    /**
     * ãƒ•ã‚¡ã‚¤ãƒ«ã®ã‚­ãƒ¥ãƒ¼ã‚’1ã¤ãšã¤éåŒæœŸã§å‡¦ç†ã™ã‚‹
     * @param {Array<string>} queue - å‡¦ç†å¯¾è±¡ã®ãƒ•ã‚¡ã‚¤ãƒ«IDã®é…åˆ—
     */
    function processFileQueue(queue) {
        const statusDiv = document.getElementById('file-list-status');

        if (queue.length === 0) {
            statusDiv.textContent = 'ã™ã¹ã¦ã®ãƒ•ã‚¡ã‚¤ãƒ«ã®å‡¦ç†ãŒå®Œäº†ã—ã¾ã—ãŸã€‚';
            statusDiv.className = 'success';
            document.getElementById('bulk-generate-titles-button').disabled = false;
            document.getElementById('move-files-button').disabled = false;
            document.getElementById('refresh-file-list-button').disabled = false;
            handleRefreshFileListClick();
            return;
        }

        const currentFileId = queue.shift();
        const liElement = document.querySelector(`input.file-checkbox[value="${currentFileId}"]`).closest('li');
        const originalFileName = liElement.querySelector('label').textContent.trim();
        
        statusDiv.textContent = `(${queue.length + 1}ä»¶ä¸­) ã€Œ${originalFileName}ã€ã®ã‚¿ã‚¤ãƒˆãƒ«ã‚’ç”Ÿæˆä¸­...`;
        statusDiv.className = '';

        google.script.run
            .withSuccessHandler(function(newTitle) {
                statusDiv.textContent = `ã€Œ${originalFileName}ã€ã®åå‰ã‚’ã€Œ${newTitle}ã€ã«å¤‰æ›´ã—ã¾ã—ãŸã€‚`;
                statusDiv.className = 'success';
                const label = liElement.querySelector('label');
                if (label) {
                    const checkbox = label.querySelector('.file-checkbox');
                    label.textContent = newTitle;
                    if(checkbox) {
                        label.prepend(checkbox);
                        // Add space after checkbox
                        checkbox.insertAdjacentText('afterend', ' ');
                    }
                }

                setTimeout(() => {
                    processFileQueue(queue);
                }, 5000);
            })
            .withFailureHandler(function(error) {
                statusDiv.textContent = `ã€Œ${originalFileName}ã€ã®å‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${error.message}`;
                statusDiv.className = 'error';
                setTimeout(() => {
                    processFileQueue(queue);
                }, 5000);
            })
            .generateAndRenameFile(currentFileId);
    }
</script>