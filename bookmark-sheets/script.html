<script>
  // openTab function removed

  document.addEventListener('DOMContentLoaded', (event) => {
    // 初回ロード時に保存済みのスプレッドシート情報を取得し表示
    google.script.run
      .withSuccessHandler(displaySavedSpreadsheetLink)
      .getSavedSpreadsheetInfo();

    // const displayTabButton = document.getElementById('displayTabButton'); // Removed
    const reloadContentButton = document.getElementById('reloadContentButton'); // リロードボタンを取得

    // if (displayTabButton) displayTabButton.addEventListener('click', () => openTab('Display', displayTabButton)); // Removed
    // settingsTabButton listener removed

    // if (displayTabButton) openTab('Display', displayTabButton); // Removed

    // Event listeners for settings elements (searchInput, searchButton, idInput, saveSettingsButton, selector, modal buttons) removed.

    // リロードボタンにイベントリスナーを追加
    if (reloadContentButton) reloadContentButton.addEventListener('click', () => {
      google.script.run
        .withSuccessHandler(function(info) {
          if (info && info.id) {
            loadSheetContent(info.id); // 保存済みのIDでコンテンツを再読み込み
          } else {
            displayContent({ error: 'ロードするスプレッドシートが設定されていません。', sheetName: '（未選択）' });
          }
        })
        .withFailureHandler(function(error) {
          displayContent({ error: '保存済みスプレッドシート情報の取得に失敗しました: ' + error.message, sheetName: '（エラー）' });
        })
        .getSavedSpreadsheetInfo();
    });
  });

  // Functions searchSpreadsheets, populateSpreadsheetSelector, handleSearchError, getTitleForId, saveSettings, showConfirmationModal, confirmSave, closeModal were moved to settings.js.html

  // This version of displaySavedSpreadsheetLink is for index.html (Display Tab)
  // It updates the currentSheetName and calls loadSheetContent.
  // It does NOT interact with 'spreadsheetLinkContainerInSettings' or 'sheetsInfoContainer' from settings.html.
  function displaySavedSpreadsheetLink(spreadsheetInfo) {
    // const linkContainer = document.getElementById('spreadsheetLinkContainerInSettings'); // This element is in settings.html
    // if (linkContainer) linkContainer.innerHTML = ''; // Not needed for index.html version

    const currentSheetNameElement = document.getElementById('currentSheetName');

    if (spreadsheetInfo && spreadsheetInfo.id && spreadsheetInfo.title) {
      // const link = document.createElement('a'); // Link is displayed in settings.html
      // link.href = 'https://docs.google.com/spreadsheets/d/' + spreadsheetInfo.id + '/edit';
      // link.textContent = 'スプレッドシートを開く: ' + spreadsheetInfo.title;
      // link.target = '_blank';
      // link.classList.add('open-spreadsheet-button');
      // if (linkContainer) linkContainer.appendChild(link); // Not for index.html

      // For index.html, we primarily update the content display, not a link in settings.
      // The 'currentSheetName' might be updated by displayContent itself later.
      // displaySheetsInfo is specific to the settings page, so we don't call it here.
      // google.script.run
      //   .withSuccessHandler(displaySheetsInfo) // displaySheetsInfo is for settings page
      //   .withFailureHandler(function(error) {
      //     displaySheetsInfo(null, 'シート情報の取得に失敗しました: ' + error.message);
      //   })
      //   .getSpreadsheetSheetsInfo(spreadsheetInfo.id);

      loadSheetContent(spreadsheetInfo.id);

    } else {
      // if (linkContainer) linkContainer.textContent = '現在、スプレッドシートは選択されていません。'; // Not for index.html
      // displaySheetsInfo(null); // displaySheetsInfo is for settings page
      if(currentSheetNameElement) currentSheetNameElement.textContent = '（未選択）';
      displayContent({ error: 'スプレッドシートが選択されていません。', sheetName: '（未選択）' });
    }
  }

  // displaySheetsInfo is now specific to settings.js.html and has been removed from script.html
  // function displaySheetsInfo(sheetsInfo, errorMessage = null) { ... }


  function loadSheetContent(spreadsheetId) {
    const displayContainer = document.getElementById('displayContentContainer');
    displayContainer.innerHTML = '<p class="no-content-message">コンテンツをロード中...</p>';
    document.getElementById('currentSheetName').textContent = 'ロード中...';

    google.script.run
      .withSuccessHandler(displayContent)
      .withFailureHandler(function(error) {
        displayContent({ error: 'コンテンツのロードに失敗しました: ' + error.message, sheetName: '（エラー）' });
      })
      .getSheetContent(spreadsheetId);
  }

  function displayContent(data) {
    const displayContainer = document.getElementById('displayContentContainer');
    displayContainer.innerHTML = '';
    const currentSheetNameElement = document.getElementById('currentSheetName');

    if (data.sheetName) {
      currentSheetNameElement.textContent = data.sheetName;
    } else {
      currentSheetNameElement.textContent = '（シート情報なし）';
    }

    if (data.error) {
      displayContainer.innerHTML = '<p class="no-content-message error">エラー: ' + data.error + '</p>';
      return;
    }

    if (!data.content || data.content.length === 0) {
      displayContainer.innerHTML = '<p class="no-content-message">表示するコンテンツがありません。</p>';
      return;
    }

    const requiredHeaders = ['url', 'title', 'image'];
    const hasTagsHeader = data.headers.some(h => String(h).toLowerCase().startsWith('tags'));
    const missingRequired = requiredHeaders.filter(h => !data.headers.includes(h));

    if (missingRequired.length > 0 || !hasTagsHeader) {
      displayContainer.innerHTML = `
        <p class="no-content-message error">
          コンテンツ表示に必要なヘッダが不足しています。<br>
          必須ヘッダ: ${requiredHeaders.join(', ')} (全て必要)<br>
          タグヘッダ: 少なくとも1つの 'tags' で始まるヘッダ (例: 'tags', 'tags_jp', etc.) が必要です。<br>
          現在のヘッダ: ${data.headers.join(', ')}
        </p>
      `;
      return;
    }

    data.content.forEach(row => {
      const itemDiv = document.createElement('div');
      itemDiv.classList.add('content-item');

      const url = row.url || '#';
      const title = row.title || 'タイトルなし';
      const image = row.image || '';

      itemDiv.innerHTML += `<h3>${title}</h3>`;
      if (image) {
        itemDiv.innerHTML += `<img src="${image}" alt="${title}">`;
      }
      itemDiv.innerHTML += `<a href="${url}" target="_blank" class="url">${url}</a>`;

      let allTags = [];
      for (const key in row) {
        if (key.toLowerCase().startsWith('tags') && row[key]) {
          const tagsInColumn = String(row[key]).split(',').map(tag => tag.trim()).filter(tag => tag !== '');
          allTags = allTags.concat(tagsInColumn);
        }
      }

      if (allTags.length > 0) {
        const tagsDiv = document.createElement('div');
        tagsDiv.classList.add('tags');
        tagsDiv.textContent = 'タグ: ';
        const tagListDiv = document.createElement('div');
        tagListDiv.classList.add('tag-list');
        allTags.forEach(tag => {
          const tagSpan = document.createElement('span');
          tagSpan.classList.add('tag-item');
          tagSpan.textContent = tag;
          tagListDiv.appendChild(tagSpan);
        });
        tagsDiv.appendChild(tagListDiv);
        itemDiv.appendChild(tagsDiv);
      } else {
        itemDiv.innerHTML += `<div class="tags">タグ: なし</div>`;
      }

      displayContainer.appendChild(itemDiv);
    });
  }
</script>